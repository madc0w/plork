<!DOCTYPE html>
<html>
	<head>
		<title>Plork</title>
		<link rel="icon" type="image/x-icon" href="favicon.ico" />
		<!-- <link rel="stylesheet" type="text/css" href="style.css" /> -->

		<script src="files.js"></script>
	</head>

	<script>
		const baseUrl = 'https://plork.duckdns.org';
		const urlParams = new URLSearchParams(window.location.search);
		let index = parseInt(urlParams.get('i')) || 0;
		let currentDir = urlParams.get('dir') || null;
		let isTransitioning = false;
		let filenames = [];
		let currentDirPath = '';

		// Function to toggle directory panel
		function toggleDirectoryPanel() {
			const panel = document.getElementById('directory-panel');
			const toggleBtn = document.getElementById('panel-toggle');

			panel.classList.toggle('collapsed');

			if (panel.classList.contains('collapsed')) {
				toggleBtn.textContent = '‚ñ∫';
				toggleBtn.title = 'Expand directory panel';
			} else {
				toggleBtn.textContent = '‚óÑ';
				toggleBtn.title = 'Collapse directory panel';
			}
		}

		// Function to get files from a specific directory path
		function getFilesFromPath(path) {
			// console.log('getFilesFromPath', path);
			if (!fileData) {
				console.error('fileData is not available');
				return [];
			}

			if (!path || path === '') {
				return fileData.files || [];
			}

			const pathParts = path.split('/');
			let current = fileData;
			for (const part of pathParts) {
				if (current?.directories?.[part]) {
					current = current.directories[part];
				} else {
					console.warn('Path not found:', path);
					return [];
				}
			}

			return current.files || [];
		}

		// Function to build directory tree structure
		function buildDirectoryTree(directories, parentPath = '') {
			const tree = [];
			for (const [dirName, dirData] of Object.entries(directories)) {
				const fullPath = parentPath ? `${parentPath}/${dirName}` : dirName;
				const hasFiles = dirData.files && dirData.files.length > 0;
				const hasSubdirs =
					dirData.directories && Object.keys(dirData.directories).length > 0;

				tree.push({
					name: dirName,
					path: fullPath,
					hasFiles: hasFiles,
					hasSubdirs: hasSubdirs,
					children: hasSubdirs
						? buildDirectoryTree(dirData.directories, fullPath)
						: [],
				});
			}
			return tree.reverse();
		}

		// Function to render directory tree
		function renderDirectoryTree(tree, container, level = 0) {
			tree.forEach((item) => {
				const itemDiv = document.createElement('div');
				itemDiv.className = 'tree-item';
				itemDiv.style.marginLeft = `${level * 20}px`;

				const toggleBtn = document.createElement('span');
				toggleBtn.className = 'tree-toggle';
				toggleBtn.textContent = item.hasSubdirs ? '‚ñ∂' : '  ';

				const nameSpan = document.createElement('span');
				nameSpan.className = 'tree-name';
				nameSpan.textContent = item.name;
				nameSpan.setAttribute('data-path', item.path);
				if (item.hasFiles) {
					nameSpan.style.cursor = 'pointer';
					nameSpan.style.color = '#4caf50';
					nameSpan.onclick = () => selectDirectory(item.path);
				}

				itemDiv.appendChild(toggleBtn);
				itemDiv.appendChild(nameSpan);
				container.appendChild(itemDiv);

				if (item.hasSubdirs) {
					const childContainer = document.createElement('div');
					childContainer.className = 'tree-children';
					childContainer.style.display = 'none';
					container.appendChild(childContainer);

					toggleBtn.style.cursor = 'pointer';
					toggleBtn.onclick = () => {
						const isOpen = childContainer.style.display === 'block';
						childContainer.style.display = isOpen ? 'none' : 'block';
						toggleBtn.textContent = isOpen ? '‚ñ∂' : '‚ñº';
					};

					renderDirectoryTree(item.children, childContainer, level + 1);
				}
			});
		}

		// Function to update directory highlighting
		function updateDirectoryHighlight() {
			// Remove previous selection
			const allTreeNames = document.querySelectorAll('.tree-name');
			allTreeNames.forEach((name) => name.classList.remove('selected'));

			// Highlight current directory
			if (currentDir) {
				const currentTreeName = document.querySelector(
					`[data-path="${currentDir}"]`
				);
				if (currentTreeName) {
					currentTreeName.classList.add('selected');
				}
			}
		}

		// Function to select a directory and load its files
		function selectDirectory(dirPath) {
			currentDir = dirPath;
			currentDirPath = dirPath;
			filenames = getFilesFromPath(dirPath);
			index = 0;

			// Update URL
			const url = new URL(window.location);
			url.searchParams.set('dir', dirPath);
			url.searchParams.set('i', '0');
			window.history.replaceState({}, '', url);

			updateDirectoryHighlight();
			updateDisplay();
		}

		// Initialize directory tree and load initial files
		function initializeApp() {
			// Wait a bit for files.js to load, then try again if needed
			if (typeof fileData === 'undefined') {
				// console.log('fileData not yet loaded, waiting...');
				setTimeout(initializeApp, 100);
				return;
			}

			// Debug: Check if fileData is available
			// console.log('fileData:', fileData);
			// console.log(
			// 	'fileData.directories:',
			// 	fileData ? fileData.directories : 'undefined'
			// );

			if (!fileData || !fileData.directories) {
				console.error('fileData or fileData.directories is not available');
				document.getElementById('directory-tree').innerHTML =
					'<div style="color: red;">Error: File data not loaded</div>';
				return;
			}

			// Build and render directory tree
			const tree = buildDirectoryTree(fileData.directories);
			// console.log('Built tree:', tree);
			const treeContainer = document.getElementById('directory-tree');
			renderDirectoryTree(tree, treeContainer);

			// Load initial directory and files
			if (currentDir) {
				filenames = getFilesFromPath(currentDir);
				currentDirPath = currentDir;
			} else {
				// Default to first directory with files
				const firstDirWithFiles = tree.find((item) => item.hasFiles);
				// console.log('First dir with files:', firstDirWithFiles);
				if (firstDirWithFiles) {
					currentDir = firstDirWithFiles.path;
					currentDirPath = firstDirWithFiles.path;
					filenames = getFilesFromPath(currentDir);

					// Update URL
					const url = new URL(window.location);
					url.searchParams.set('dir', currentDir);
					window.history.replaceState({}, '', url);
				}
			}

			updateDirectoryHighlight();
			updateDisplay();
		}

		function createMediaElement(src) {
			if (src.toLowerCase().match(/\.(mpg|avi|mp4)$/i)) {
				return `<video controls><source src="${src}" type="video/mp4"/></video>`;
			} else {
				return `<img src="${src}" alt="Image"/>`;
			}
		}

		function updateDisplay() {
			if (filenames.length === 0) {
				document.getElementById('counter').textContent =
					'No files in directory';
				document.getElementById('file-container').innerHTML =
					'<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">No files to display</div>';
				return;
			}

			const url = new URL(window.location);
			url.searchParams.set('i', index);
			url.searchParams.set('dir', currentDir);
			window.history.replaceState({}, '', url);

			// Construct URL similar to original: baseUrl/{dirPath}/{filename}
			// Need to handle encoding properly for directory path with spaces
			const encodedDirPath = encodeURIComponent(currentDirPath).replace(
				/%2F/g,
				'/'
			);
			const src = `${baseUrl}/${encodedDirPath}/${encodeURIComponent(
				filenames[index]
			)}`;
			// console.log('Loading image from:', src);
			const html = createMediaElement(src);

			// Clear container and add new slide
			const container = document.getElementById('file-container');
			container.innerHTML = '';
			const slide = document.createElement('div');
			slide.className = 'slide';
			slide.innerHTML = html;
			container.appendChild(slide);

			// Update counter
			document.getElementById('counter').textContent = `${index + 1} / ${
				filenames.length
			} - ${currentDirPath}`;
		}

		function slideToImage(newIndex, direction) {
			if (isTransitioning || filenames.length === 0) return;
			isTransitioning = true;

			// Disable navigation arrows
			document.getElementById('left-arrow').classList.add('disabled');
			document.getElementById('right-arrow').classList.add('disabled');

			const container = document.getElementById('file-container');
			// Fix URL encoding to match original pattern
			const encodedDirPath = encodeURIComponent(currentDirPath).replace(
				/%2F/g,
				'/'
			);
			const newSrc = `${baseUrl}/${encodedDirPath}/${encodeURIComponent(
				filenames[newIndex]
			)}`;

			// Get current slide
			const currentSlide = container.querySelector('.slide');

			// Create new slide element
			const newSlide = document.createElement('div');
			newSlide.className = 'slide';
			newSlide.innerHTML = createMediaElement(newSrc);

			// Position new slide off-screen
			if (direction === 'right') {
				newSlide.style.transform = 'translateX(100%)';
			} else {
				newSlide.style.transform = 'translateX(-100%)';
			}

			// Add new slide to container
			container.appendChild(newSlide);

			// Force reflow
			newSlide.offsetHeight;

			// Animate slides
			requestAnimationFrame(() => {
				if (currentSlide) {
					currentSlide.style.transform = `translateX(${
						direction === 'right' ? -100 : 100
					}%)`;
				}
				newSlide.style.transform = 'translateX(0)';

				// Clean up after transition
				setTimeout(() => {
					// Remove all slides except the new one
					const allSlides = container.querySelectorAll('.slide');
					allSlides.forEach((slide) => {
						if (slide !== newSlide) {
							slide.remove();
						}
					});

					isTransitioning = false;

					// Re-enable navigation arrows
					document.getElementById('left-arrow').classList.remove('disabled');
					document.getElementById('right-arrow').classList.remove('disabled');
				}, 200);
			});

			index = newIndex;

			// Update counter
			document.getElementById('counter').textContent = `${index + 1} / ${
				filenames.length
			} - ${currentDirPath}`;

			// Update URL
			const url = new URL(window.location);
			url.searchParams.set('i', index);
			url.searchParams.set('dir', currentDir);
			window.history.replaceState({}, '', url);
		}

		function previousImage() {
			if (isTransitioning) return;
			const newIndex = index - 1 < 0 ? filenames.length - 1 : index - 1;
			slideToImage(newIndex, 'left');
		}

		function nextImage() {
			if (isTransitioning) return;
			const newIndex = index + 1 >= filenames.length ? 0 : index + 1;
			slideToImage(newIndex, 'right');
		}

		function downloadCurrentFile() {
			if (filenames.length === 0) return;

			const currentFilename = filenames[index];
			// Fix URL encoding to match original pattern
			const encodedDirPath = encodeURIComponent(currentDirPath).replace(
				/%2F/g,
				'/'
			);
			const src = `${baseUrl}/${encodedDirPath}/${encodeURIComponent(
				currentFilename
			)}`;

			// Create a temporary anchor element to trigger download
			const link = document.createElement('a');
			link.href = src;
			link.download = currentFilename;
			link.target = '_blank';
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);
		}

		// Keyboard navigation
		document.addEventListener('keydown', function (event) {
			if (!isTransitioning) {
				if (event.key === 'ArrowLeft') {
					previousImage();
				} else if (event.key === 'ArrowRight') {
					nextImage();
				}
			}
		});
	</script>

	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 0;
			padding: 0;
			background-color: #f4f4f4;
			height: 100vh;
			overflow: hidden;
			display: flex;
			flex-direction: column;
		}

		h1 {
			color: #333;
			text-align: center;
			margin: 20px 0;
			flex-shrink: 0;
		}

		p {
			color: #666;
		}

		.app-container {
			flex: 1;
			display: flex;
			min-height: 0;
			margin-top: 40px; /* Add margin to push content below the fixed header */
		}

		.directory-panel {
			width: 300px;
			background-color: #fff;
			border-right: 2px solid #ddd;
			overflow-y: auto;
			padding: 10px;
			padding-top: 50px; /* Make space for toggle button */
			box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
			transition: width 0.3s ease, padding 0.3s ease;
			position: relative;
		}

		.directory-panel.collapsed {
			width: 50px;
			padding: 10px 5px;
			padding-top: 50px; /* Keep space for toggle button when collapsed */
		}

		.directory-panel.collapsed #directory-tree {
			display: none;
		}

		.directory-panel h3 {
			margin: 0 0 15px 0;
			color: #333;
			font-size: 16px;
			border-bottom: 1px solid #eee;
			padding-bottom: 8px;
		}

		.tree-item {
			display: flex;
			align-items: center;
			padding: 2px 0;
			user-select: none;
		}

		.tree-toggle {
			width: 20px;
			display: inline-block;
			text-align: center;
			color: #666;
			font-size: 12px;
		}

		.tree-name {
			flex: 1;
			padding: 4px 8px;
			border-radius: 3px;
			transition: background-color 0.2s;
		}

		.tree-name:hover {
			background-color: #f0f0f0;
		}

		.tree-name.selected {
			background-color: #4caf50 !important;
			color: white !important;
			font-weight: bold;
		}

		.tree-name.selected:hover {
			background-color: #45a049 !important;
			color: white !important;
		}

		.panel-toggle {
			position: absolute;
			top: 10px;
			right: 10px;
			width: 30px;
			height: 30px;
			background: linear-gradient(135deg, #4caf50, #45a049);
			color: white;
			border: none;
			border-radius: 50%;
			cursor: pointer;
			font-size: 16px;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.3s ease;
			z-index: 10;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		.panel-toggle:hover {
			background: linear-gradient(135deg, #45a049, #3d8b40);
			transform: scale(1.1);
			box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
		}

		.panel-toggle:active {
			transform: scale(0.95);
		}

		/* Ensure toggle button is visible when collapsed */
		.directory-panel.collapsed .panel-toggle {
			right: 10px; /* Center it in the collapsed panel */
		}

		.main-container {
			flex: 1;
			display: flex;
			align-items: center;
			justify-content: center;
			position: relative;
			min-height: 0;
			margin-top: 50px;
		}

		#file-container {
			width: calc(100% - 120px);
			height: calc(100vh - 100px);
			margin: 40px 0;
			position: relative;
			overflow: hidden;
		}

		.slide {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: transform 0.3s ease-in-out;
		}

		.slide img,
		.slide video {
			max-width: 100%;
			max-height: 100%;
			object-fit: contain;
		}

		.nav-arrow {
			position: absolute;
			top: 50%;
			transform: translateY(-50%);
			font-size: 30px;
			color: #555;
			cursor: pointer;
			user-select: none;
			padding: 10px;
			background: linear-gradient(
				135deg,
				rgba(255, 255, 255, 0.95),
				rgba(240, 240, 240, 0.95)
			);
			border: 2px solid rgba(200, 200, 200, 0.3);
			border-radius: 50%;
			width: 50px;
			height: 50px;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.3s ease;
			z-index: 10;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
		}

		.nav-arrow:hover {
			background: linear-gradient(135deg, #4caf50, #45a049);
			color: white;
			border-color: rgba(76, 175, 80, 0.3);
			transform: translateY(-50%) scale(1.1);
			box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
		}

		.nav-arrow:active {
			transform: translateY(-50%) scale(0.95);
			box-shadow: 0 2px 6px rgba(76, 175, 80, 0.4);
		}

		.nav-arrow.disabled {
			opacity: 0.3;
			cursor: not-allowed;
			pointer-events: none;
		}

		.nav-arrow.left {
			left: 20px;
		}

		.nav-arrow.right {
			right: 20px;
		}

		.download-button {
			position: fixed;
			top: 20px;
			right: 20px;
			width: 50px;
			height: 50px;
			background: linear-gradient(
				135deg,
				rgba(255, 255, 255, 0.95),
				rgba(240, 240, 240, 0.95)
			);
			border: 2px solid rgba(200, 200, 200, 0.3);
			border-radius: 50%;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 18px;
			color: #555;
			transition: all 0.3s ease;
			z-index: 20;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
		}

		.download-button:hover {
			background: linear-gradient(135deg, #4caf50, #45a049);
			color: white;
			border-color: rgba(76, 175, 80, 0.3);
			transform: scale(1.1);
			box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
		}

		.download-button:active {
			transform: scale(0.95);
			box-shadow: 0 2px 6px rgba(76, 175, 80, 0.4);
		}
	</style>

	<body onload="initializeApp()">
		<!-- <h1>Plork</h1> -->
		<div
			id="counter"
			style="
				text-align: center;
				padding: 10px;
				font-size: 16px;
				color: #333;
				background-color: rgba(255, 255, 255, 0.9);
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				z-index: 20;
			"
		></div>
		<button
			class="download-button"
			onclick="downloadCurrentFile()"
			title="Download current file"
		>
			‚Üì
		</button>
		<div class="app-container">
			<div class="directory-panel" id="directory-panel">
				<button
					class="panel-toggle"
					onclick="toggleDirectoryPanel()"
					id="panel-toggle"
					title="Collapse directory panel"
				>
					‚óÑ
				</button>
				<!-- <h3>üìÅ Directories</h3> -->
				<div id="directory-tree"></div>
			</div>
			<div class="main-container">
				<div class="nav-arrow left" onclick="previousImage()" id="left-arrow">
					‚Äπ
				</div>
				<div id="file-container"></div>
				<div class="nav-arrow right" onclick="nextImage()" id="right-arrow">
					‚Ä∫
				</div>
			</div>
		</div>
	</body>
</html>
